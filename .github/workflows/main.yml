name: Setup RDP Full
on:
  workflow_dispatch:

jobs:
  run-setup:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run setup-rdp.ps1 script
        shell: powershell
        run: |
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
          $scriptPath = "$GITHUB_WORKSPACE\setup-rdp.ps1"
          if (-not (Test-Path $scriptPath)) {
              Write-Error "setup-rdp.ps1 not found in repo root."
              exit 1
          }

          Write-Host "========== Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° setup-rdp.ps1 ==========" -ForegroundColor Cyan

          # ---- 1) ØªÙØ¹ÙŠÙ„ Remote Desktop ----
          Write-Host "ğŸ”¹ ØªÙØ¹ÙŠÙ„ Remote Desktop..."
          try {
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
              Write-Host "âœ… RDP Ù…ÙØ¹Ù„ ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¬Ø¯Ø§Ø± Ø§Ù„Ù†Ø§Ø±ÙŠ Ù…ÙØ¹Ù„Ø©."
          } catch {
              Write-Host "âš ï¸ ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ RDP: $_" -ForegroundColor Yellow
          }

          # ---- 2) Ø¥Ù†Ø´Ø§Ø¡ / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ----
          $username = "MURTADALAW"
          $plainPassword = "11qazz@$C"

          Write-Host "ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $username"
          try {
              $securePass = ConvertTo-SecureString $plainPassword -AsPlainText -Force
              if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
                  New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -Description "RDP user created by setup-rdp.ps1"
                  Write-Host "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… $username"
              } else {
                  $u = Get-LocalUser -Name $username
                  $u | Set-LocalUser -Password $securePass
                  Write-Host "â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ â€” ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."
              }

              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          } catch {
              Write-Host "âš ï¸ ÙØ´Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: $_" -ForegroundColor Yellow
          }

          # ---- 3) ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ ----
          Write-Host "ğŸ”¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡: ØªØ¹Ø·ÙŠÙ„ Ù…Ø¤Ø«Ø±Ø§Øª Ø¨ØµØ±ÙŠØ© ÙˆØ¨Ø¹Ø¶ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø®ÙÙŠÙØ©"
          try {
              RunDll32.exe shell32.dll,Control_RunDLL desk.cpl,,@Themes /Action:OpenTheme
          } catch {
              # Ù„ÙŠØ³ Ø®Ø·Ø£ Ù‚Ø§ØªÙ„
          }

          # ---- 4) ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ----
          Write-Host "ğŸ”¹ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Git, Python, Node LTS, .NET SDK)..."
          try {
              try { winget upgrade --all --silent } catch { }

              $apps = @("Git.Git", "Python.Python.3.12", "OpenJS.NodeJS.LTS", "Microsoft.DotNet.SDK.8")
              foreach ($app in $apps) {
                  Write-Host "â¡ï¸ ØªØ«Ø¨ÙŠØª $app ..."
                  winget install --id $app -e --silent --accept-package-agreements --accept-source-agreements -h
              }
              Write-Host "âœ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù†ØªÙ‡Ù‰."
          } catch {
              Write-Host "âš ï¸ Ø­Ø¯Ø«Øª Ø£Ø®Ø·Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø£Ø¯ÙˆØ§Øª: $_" -ForegroundColor Yellow
          }

          # ---- 5) Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ----
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "Ø¥Ø¹Ø¯Ø§Ø¯ RDP Ø§Ù†ØªÙ‡Ù‰. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:" -ForegroundColor Green
          Write-Host "  â¤ Username: $username"
          Write-Host "  â¤ Password: $plainPassword"
          Write-Host "Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ø³ØªØ®Ø¯Ù… Tailscale Ø£Ùˆ VPN." -ForegroundColor Yellow
          Write-Host "=============================================" -ForegroundColor Cyan
