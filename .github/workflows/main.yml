name: Setup RDP Full
on:
  workflow_dispatch:

jobs:
  run-setup:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run setup-rdp.ps1 script
        shell: powershell
        run: |
          # التحقق من وجود السكربت
          $scriptPath = "$GITHUB_WORKSPACE\setup-rdp.ps1"
          if (-not (Test-Path $scriptPath)) {
              Write-Error "setup-rdp.ps1 not found in repo root."
              exit 1
          }

          Write-Host "========== بدء تنفيذ setup-rdp.ps1 ==========" -ForegroundColor Cyan

          # ---- 1) تفعيل Remote Desktop ----
          Write-Host "🔹 تفعيل Remote Desktop..."
          try {
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
              Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
              Write-Host "✅ RDP مفعل وقواعد الجدار الناري مفعلة."
          } catch {
              Write-Host "⚠️ فشل تفعيل RDP: $_" -ForegroundColor Yellow
          }

          # ---- 2) إنشاء / تحديث المستخدم ----
          $username = "MURTADALAW"
          $plainPassword = "11qazz@$C"

          Write-Host "🔹 إعداد المستخدم: $username"
          try {
              $securePass = ConvertTo-SecureString $plainPassword -AsPlainText -Force
              if (-not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
                  New-LocalUser -Name $username -Password $securePass -AccountNeverExpires -Description "RDP user created by setup-rdp.ps1"
                  Write-Host "✅ تم إنشاء المستخدم $username"
              } else {
                  $u = Get-LocalUser -Name $username
                  $u | Set-LocalUser -Password $securePass
                  Write-Host "ℹ️ المستخدم موجود — تم تحديث كلمة المرور."
              }

              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          } catch {
              Write-Host "⚠️ فشل إعداد المستخدم: $_" -ForegroundColor Yellow
          }

          # ---- 3) تحسين الأداء ----
          Write-Host "🔹 تحسين الأداء: تعطيل مؤثرات بصرية وبعض الخدمات الخفيفة"
          try {
              RunDll32.exe shell32.dll,Control_RunDLL desk.cpl,,@Themes /Action:OpenTheme
          } catch {
              # ليس خطأ قاتل
          }

          # ---- 4) تثبيت الأدوات الأساسية ----
          Write-Host "🔹 تثبيت الأدوات الأساسية (Git, Python, Node LTS, .NET SDK)..."
          try {
              try { winget upgrade --all --silent } catch { }

              $apps = @("Git.Git", "Python.Python.3.12", "OpenJS.NodeJS.LTS", "Microsoft.DotNet.SDK.8")
              foreach ($app in $apps) {
                  Write-Host "➡️ تثبيت $app ..."
                  winget install --id $app -e --silent --accept-package-agreements --accept-source-agreements -h
              }
              Write-Host "✅ تثبيت الأدوات الأساسية انتهى."
          } catch {
              Write-Host "⚠️ حدثت أخطاء أثناء تثبيت الأدوات: $_" -ForegroundColor Yellow
          }

          # ---- 5) النتيجة النهائية ----
          Write-Host "=============================================" -ForegroundColor Cyan
          Write-Host "إعداد RDP انتهى. معلومات الدخول:" -ForegroundColor Green
          Write-Host "  ➤ Username: $username"
          Write-Host "  ➤ Password: $plainPassword"
          Write-Host "ملاحظة: للوصول من خارج الشبكة استخدم Tailscale أو VPN." -ForegroundColor Yellow
          Write-Host "=============================================" -ForegroundColor Cyan
